
<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    
    <meta name="docsearch:name" content="ReaL" />
    <meta name="docsearch:package_type" content="" />
    <meta name="docsearch:release" content="0.3.0" />
    <meta name="docsearch:version" content="" />
    
      <title>Configurations &mdash; ReaL 0.3.0 documentation</title>
    
    <link rel="canonical" href="expconfig" />
          <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8e8a900e" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/custom.css?v=97da1bf0" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/sphinx-nefertiti-default.min.css?v=0f5ffd77" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/fonts/nunito/stylesheet.css?v=0ed606bc" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/fonts/red-hat-mono/stylesheet.css?v=4eee5046" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/pygments-dark.css?v=2de69186" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/pygments-light.css?v=970f37b1" /><!-- add (1) -->
          <link rel="stylesheet" type="text/css" href="_static/bootstrap-icons.min.css?v=44730005" /><!-- add (1) -->
        <link rel="index" title="Index" href="genindex.html" />
        <link rel="search" title="Search" href="search.html" />
        <link rel="top" title="ReaL 0.3.0 documentation" href="#" />
        <link rel="next" title="Quickstart" href="quickstart.html" />
        <link rel="prev" title="Installation" href="install.html" />
    <style>
      :root {
        --nftt-body-font-family: "Nunito", var(--nftt-font-sans-serif) !important;
        --nftt-font-monospace: "Red Hat Mono", var(--nftt-font-family-monospace) !important;
        --nftt-project-name-font: var(--nftt-body-font-family);
        --nftt-documentation-font: var(--nftt-body-font-family);
        --nftt-doc-headers-font: "Georgia", var(--nftt-documentation-font);}
      h1 *, h2 *, h3 *, h4 *, h5 *, h6 * { font-size: inherit; }
    </style>
  </head>
  <body>
    <div id="back-to-top-container" class="position-fixed start-50 translate-middle-x">
      <button id="back-to-top" type="button" class="d-none btn btn-neutral btn-sm shadow px-4" data-bs-toggle="button">Back to top</button>
    </div>
    <header id="snftt-nav-bar" class="navbar navbar-expand-xl navbar-dark nftt-navbar flex-column fixed-top">
      <div class="skip-links container-fluid visually-hidden-focusable overflow-hidden justify-content-start flex-grow-1">
        <div class="border-bottom mb-2 pb-2 w-100">
          <a class="d-none d-md-inline-flex p-2 m-1" href="#sidebar-filter">Skip to docs navigation</a>
          <a class="d-inline-flex p-2 m-1" href="#content">Skip to main content</a>
        </div>
      </div>
      <nav class="container-xxl nftt-gutter flex-wrap flex-xl-nowrap" aria-label="Main navigation">
        <div class="nftt-navbar-toggler">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar" aria-label="Toggle documentation navigation">
            <i class="bi bi-list"></i>
          </button>
        </div>
          <a href="index.html"
              
              class="navbar-brand p-0 me-0 md-lg-2 pe-lg-4"
          ><span class="brand-text">ReaL</span></a>
        
        
        <div class="d-flex d-xl-none">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttSearch" aria-controls="nfttSearch" aria-label="Search">
            <i class="bi bi-search"></i>
          </button>
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttNavbar" aria-controls="nfttNavbar" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
        </div>
        
<div class="offcanvas-xl offcanvas-end flex-grow-1" tabindex="-1" id="nfttSearch" aria-labelledby="nfttSearchOffcanvasLabel" data-bs-scroll="true">
  <div class="offcanvas-header px-4 pb-0">
    <h5 class="offcanvas-title fw-bold" id="nfttSearchOffcanvasLabel">Search the documentation</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttSearch"></button>
  </div>
  <div class="offcanvas-body p-4 pt-0 p-xl-0 ps-xl-4">
    <hr class="d-xl-none text-white-50">
    <ul class="navbar-nav flex-row align-items-center flex-wrap ms-md-auto">
      <li class="nav-item col-12 col-xl-auto">
        <form id="nftt-search-form" action="search.html" method="get">
          <div class="input-group">
            <input type="text" name="q" class="form-control search-input" placeholder="Search docs" aria-label="Search" aria-describedby="button-search">
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <button class="btn btn-primary" type="submit" id="button-search" aria-label="Search"><i class="bi bi-search"></i></button>
          </div>
        </form>
      </li>
    </ul>
  </div>
</div>

        <div class="offcanvas-xl offcanvas-end" tabindex="-1" id="nfttNavbar" aria-labelledby="nfttNavbarOffcanvasLabel" data-bs-scroll="true">
          <div class="offcanvas-header px-4 pb-0">
            <div class="offcanvas-title navbar-brand" id="nfttNavbarOffcanvasLabel"><span class="brand-text">ReaL</span></div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttNavbar"></button>
          </div>
          <div class="offcanvas-body p-4 pt-0 p-xl-0 px-xl-3">
            <hr class="d-xl-none text-white-50">
            <ul class="navbar-nav flex-row align-items-center flex-wrap ms-lg-auto">
              
              
              
              
              <!-- colorscheme_dropdown.html -->
<li class="nav-item dropdown">
  <a class="nav-link d-flex py-2 px-0 px-xl-2 dropdown-toggle align-items-center" id="snftt-luz" href="#" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false" aria-label="Toggle light/dark">
    <i class="bi bi-circle-half" data-snftt-luz-icon-active></i>
    <span id="snftt-luz-text" class="d-xl-none ms-2">Toggle light/dark</span>
  </a>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="snftt-luz-text">
    <li>
      <h6 class="dropdown-header">Light/dark</h6>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="light" href="#" aria-pressed="false">
        <span>
          <i class="bi bi-sun" data-snftt-luz-icon="light"></i>
        </span>
        <span class="ms-3">Light</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="dark" href="#" aria-pressed="false">
        <span>
          <i class="bi bi-moon-stars" data-snftt-luz-icon="dark"></i>
        </span>
        <span class="ms-3">Dark</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item current d-flex align-items-center" data-snftt-luz="default" href="#" aria-pressed="false">
        <span>
          <i class="bi bi-circle-half" data-snftt-luz-icon="default"></i>
        </span>
        <span class="ms-3">Default</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
  </ul>
</li>
            </ul>
          </div>
        </div>
      </nav>
      
    </header>

    <div class="container-fluid flex-grow-1">
      <div class="nftt-gutter nftt-page">
        <aside class="nftt-sidebar ">
          <div class="nftt-sidebar-content">
            
            <div class="title d-none d-xl-block">
              <i class="bi bi-book"></i>&nbsp;&nbsp;<span>Index</span>
            </div>
            <div id="sidebar" tabindex="-1" class="offcanvas-xl offcanvas-start" aria-labelledby="nfttSidebarOffcanvasLabel">
                <!-- sidebartemplate: "globaltoc.html" --><div class="offcanvas-header border-bottom">
  <h5 class="offcanvas-title fw-bold" id="nfttSidebarOffcanvasLabel">
    Table of contents
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#sidebar"></button>
</div>

<div class="offcanvas-body">
  <nav class="toc" aria-label="Main menu">
    <div class="mb-3 p-1 pt-3 pb-4 border-bottom">
      <input id="sidebar-filter" type="text" name="filter" class="form-control form-control-sm" placeholder="filter" aria-label="filter">
    </div>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed.html">Setting Up Distributed Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="customization.html">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="impl.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="arch.html">Code Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>

  </nav>
  <template data-toggle-item-template>
    <button class="btn btn-sm btn-link toctree-expand" type="button">
      <i class="bi bi-caret-right"></i>
      <span class="visually-hidden">Toggle menu contents</span>
    </button>
  </template>
</div>
            </div>
            
          </div>
        </aside>
        <article id="content" class="nftt-content" role="main">
          <nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="index.html">Start</a></li>
    <li class="breadcrumb-item active" aria-current="page">Configurations</li>
  </ol>
</nav>
    <section id="configurations">
<h1>Configurations<a class="headerlink" href="#configurations" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page serves as a reference manual for the configuration objects,
i.e., you can check which attributes can be modified and their
default values. You don’t need to read through this page before
running experiments!</p>
<p>Please check the <a class="reference internal" href="quickstart.html"><span class="doc">Quickstart</span></a> and <a class="reference internal" href="customization.html"><span class="doc">Customization</span></a> sections
for concrete examples of running experiments.</p>
</div>
<p>We illustrate configurations for quickstart experiments in this page.
Each type of experiment (e.g., SFT, PPO) corresponds to a specific
configuration object (e.g., <a class="reference internal" href="#realhf.SFTConfig" title="realhf.SFTConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.SFTConfig</span></code></a> for SFT).</p>
<p>Since ReaL uses <a class="reference external" href="https://hydra.cc/">Hydra</a> for configuration
management, users can override these options provided by the class
recursively with command line arguments.</p>
<section id="experiment-configurations">
<h2>Experiment Configurations<a class="headerlink" href="#experiment-configurations" title="Link to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.ExperimentSaveEvalControl">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ExperimentSaveEvalControl</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">total_train_epochs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_freq_epochs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_freq_steps</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_freq_secs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eval_freq_epochs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eval_freq_steps</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eval_freq_secs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">benchmark_steps</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ExperimentSaveEvalControl" title="Link to this definition">¶</a></dt>
<dd><p>Utility object for controlling the frequency of saving and evaluation
during training.</p>
<p><code class="docutils literal notranslate"><span class="pre">Epoch</span></code> refers to the number of times the training loop iterates over the entire dataset.
<code class="docutils literal notranslate"><span class="pre">Step</span></code> refers to the number of iterations running the algorithm dataflow.</p>
<p>This object manages independent counters for epochs, steps, and seconds. The model will
be saved or evaluated when any of the following conditions are met.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>total_train_epochs</strong> (<em>int</em>) – The total number of epochs to train the model.</p></li>
<li><p><strong>save_freq_epochs</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Frequency in epochs at which to save the model. If None,
the model will not be saved based on epoch changes during training.</p></li>
<li><p><strong>save_freq_steps</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Frequency in steps at which to save the model. If None,
the model will not be saved based on step changes during training.</p></li>
<li><p><strong>save_freq_secs</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Frequency in seconds at which to save the model. If None,
the model will not be saved based on time changes during training.</p></li>
<li><p><strong>eval_freq_epochs</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Frequency in epochs at which to evaluate the model. If None,
the model will not be evaluated based on epoch changes during training.</p></li>
<li><p><strong>eval_freq_steps</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Frequency in steps at which to evaluate the model. If None,
the model will not be evaluated based on step changes during training.</p></li>
<li><p><strong>eval_freq_secs</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Frequency in seconds at which to evaluate the model. If None,
the model will not be evaluated based on time changes during training.</p></li>
<li><p><strong>benchmark_steps</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Terminate training after this number of steps. Used for system
benchmarking only. Set to None for normal training.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.CommonExperimentConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">CommonExperimentConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">experiment_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trial_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'slurm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'dev'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">image_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_retries:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_worker_error:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'pipe_model'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_use_cache:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_nodes:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_gpus_per_node:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nodelist:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_clear_freq:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exp_ctrl:</span> <span class="pre">~realhf.api.core.system_api.ExperimentSaveEvalControl</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.CommonExperimentConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for quickstart experiments.</p>
<p>All members can be modified via the command line. For example,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>realhf.apps.quickstart<span class="w"> </span>sft<span class="w"> </span><span class="nv">trial_name</span><span class="o">=</span>my_trial<span class="w"> </span><span class="nv">seed</span><span class="o">=</span><span class="m">42</span><span class="w"> </span>exp_ctrl.save_freq_steps<span class="o">=</span><span class="m">10</span><span class="w"> </span>...
</pre></div>
</div>
<p>This command changes the <code class="docutils literal notranslate"><span class="pre">trial_name</span></code>, <code class="docutils literal notranslate"><span class="pre">seed</span></code>, and the <code class="docutils literal notranslate"><span class="pre">save_freq_steps</span></code> attribute
of the <code class="docutils literal notranslate"><span class="pre">exp_ctrl</span></code> attribute in this class.</p>
<p><code class="docutils literal notranslate"><span class="pre">recover_mode</span></code> can be one of the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto</span></code>: Automatically recover the last failed run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save</span></code>: Save recovery states if an error occurs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resume</span></code>: Resume from saved recovery states and save states if a failure occurs again.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">disabled</span></code>: Do nothing but raise an error if one occurs.</p></li>
</ul>
<p>If you are not familiar with ReaL’s recovery mechanism, set this to <code class="docutils literal notranslate"><span class="pre">disabled</span></code>.
Normal checkpointing is usually sufficient in most cases.</p>
<p><code class="docutils literal notranslate"><span class="pre">allocation_mode</span></code> can be one of the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">manual</span></code>: Manually allocate resources using the specified command-line options.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">search</span></code>: Allocate resources and configure parallel strategies using the search engine.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">heuristic</span></code>: Allocate resources and configure parallel strategies using heuristic strategies obtained from a search.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pipe_data</span></code>: Identical parallelization (like DSChat) with pipe+data parallelism. For a world size under 8, only data parallelism will be used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pipe_model</span></code>: Identical parallelization (like DSChat) with pipe+model parallelism. For a world size under 8, only tensor-model parallelism will be used.</p></li>
<li><p>A regex pattern like <code class="docutils literal notranslate"><span class="pre">d${DP}p${PP}m${TP}</span></code>: Identical parallelization for all MFCs with ${DP}-way data parallelism, ${PP}-way pipeline parallelism, and ${TP}-way model parallelism.</p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>experiment_name</strong> (<em>str</em>) – The name of the experiment.
An arbitrary string without “_” and “/”, e.g., <code class="docutils literal notranslate"><span class="pre">ultra-chat-llama</span></code>.
This parameter is required.</p></li>
<li><p><strong>trial_name</strong> (<em>str</em>) – The name of the trial.
An arbitrary string without “-” and “/”, e.g., <code class="docutils literal notranslate"><span class="pre">lr1e-3wd0.05</span></code>.
This parameter is required.</p></li>
<li><p><strong>mode</strong> (<em>str</em>) – The experiment launching mode. Supported values are “local”, “ray”, or “slurm”.
“ray” mode requires launching the Ray cluster via CLI.
“slurm” mode requires the Pyxis plugin with the Enroot container enabled.
“local” mode implies <code class="docutils literal notranslate"><span class="pre">n_nodes=1</span></code>.</p></li>
<li><p><strong>debug</strong> (<em>bool</em>) – Whether to run in debug mode.
Setting this to <cite>False</cite> will disable all assertions, which will be faster but less safe.</p></li>
<li><p><strong>partition</strong> (<em>str</em>) – The SLURM partition for running the experiment.</p></li>
<li><p><strong>wandb_mode</strong> (<em>str</em>) – The mode for WandB. Currently, WandB logging is not supported.</p></li>
<li><p><strong>image_name</strong> (<em>str</em><em> or </em><em>None</em>) – The name of the Docker image used by the controller.
This parameter is only used in SLURM mode.</p></li>
<li><p><strong>recover_mode</strong> (<em>str</em>) – The recovery mode. See above for details.</p></li>
<li><p><strong>recover_retries</strong> (<em>int</em>) – The number of retries for recovery.
Effective only when <code class="docutils literal notranslate"><span class="pre">recover_mode</span></code> is set to “auto”.</p></li>
<li><p><strong>ignore_worker_error</strong> (<em>bool</em>) – Whether to ignore errors raised by
workers during runtime. Only set this to <cite>True</cite> if you are certain that the error can be ignored.
Effective only when <code class="docutils literal notranslate"><span class="pre">recover_mode</span></code> is set to “disabled”.</p></li>
<li><p><strong>allocation_mode</strong> (<em>str</em>) – The mode for GPU parallel strategy allocation. See above for details.</p></li>
<li><p><strong>allocation_use_cache</strong> (<em>bool</em>) – Whether to use cache in allocation search.
Effective only when <code class="docutils literal notranslate"><span class="pre">allocation_mode</span></code> is set to “search” and a cache is available in the log directory of the current experiment
name and trial.</p></li>
<li><p><strong>n_nodes</strong> (<em>int</em>) – The number of nodes to run the experiment.</p></li>
<li><p><strong>n_gpus_per_node</strong> (<em>int</em>) – The number of GPUs per node.
Thus, the total number of GPUs will be <code class="docutils literal notranslate"><span class="pre">n_nodes</span> <span class="pre">*</span> <span class="pre">n_gpus_per_node</span></code>.
ReaL supports a world size of 1, 2, 4, 8, … within a single node,
or multiple nodes with the same number of GPUs.</p></li>
<li><p><strong>nodelist</strong> (<em>str</em><em> or </em><em>None</em>) – Nodelist for the distributed setting in SLURM nodelist format.
Required for the <code class="docutils literal notranslate"><span class="pre">manual</span></code> allocation mode.
For multiple GPUs on a single node, it should be formatted as “NODE01:0,1,2,3”,
indicating the use of the first 4 GPUs on <code class="docutils literal notranslate"><span class="pre">NODE01</span></code>.
For multiple complete nodes, it should be formatted as “NODE[01-02,03,07],COM08”,
indicating the use of all GPUs on these nodes: [NODE01, NODE02, NODE03, NODE07, COM08].</p></li>
<li><p><strong>seed</strong> (<em>int</em>) – The random seed.</p></li>
<li><p><strong>cache_clear_freq</strong> (<em>int</em><em> or </em><em>None</em>) – The cache of data transfer will be cleared after each <code class="docutils literal notranslate"><span class="pre">cache_clear_freq</span></code> steps.
If None, will not clear the cache. Set to a small number, e.g., 1, if OOM or CUDA OOM occurs.</p></li>
<li><p><strong>exp_ctrl</strong> (<a class="reference internal" href="#realhf.ExperimentSaveEvalControl" title="realhf.ExperimentSaveEvalControl"><em>ExperimentSaveEvalControl</em></a>) – The control for saving and evaluating the experiment.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.SFTConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">SFTConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">experiment_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trial_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'slurm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'dev'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">image_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_retries:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_worker_error:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'pipe_model'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_use_cache:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_nodes:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_gpus_per_node:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nodelist:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_clear_freq:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exp_ctrl:</span> <span class="pre">~realhf.api.core.system_api.ExperimentSaveEvalControl</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset:</span> <span class="pre">~realhf.api.quickstart.dataset.PromptAnswerDatasetConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SFTConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for SFT experiments.</p>
<p>This class is a subclass of <a class="reference internal" href="#realhf.CommonExperimentConfig" title="realhf.CommonExperimentConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommonExperimentConfig</span></code></a>,
so all CLI options from the base class are available.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Configuration for model runtime.</p></li>
<li><p><strong>allocation</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – Configuration for device allocation and parallelism.</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="#realhf.PromptAnswerDatasetConfig" title="realhf.PromptAnswerDatasetConfig"><em>PromptAnswerDatasetConfig</em></a>) – Configuration for the dataset.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.RWConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">RWConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">experiment_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trial_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'slurm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'dev'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">image_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_retries:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_worker_error:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'pipe_model'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_use_cache:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_nodes:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_gpus_per_node:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nodelist:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_clear_freq:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exp_ctrl:</span> <span class="pre">~realhf.api.core.system_api.ExperimentSaveEvalControl</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_sft_lora:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sft_lora_path:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset:</span> <span class="pre">~realhf.api.quickstart.dataset.PairedComparisonDatasetConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.RWConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for pairwise reward modeling experiments.</p>
<p>This class is a subclass of <a class="reference internal" href="#realhf.CommonExperimentConfig" title="realhf.CommonExperimentConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommonExperimentConfig</span></code></a>,
so all CLI options from the base class are available.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>is_sft_lora</strong> (<em>bool</em>) – Whether LoRA was used for SFT.
If LoRA was used, the saved SFT model should only contain LoRA parameters.
Since LoRA is currently not supported for SFT, this option is not utilized at present.</p></li>
<li><p><strong>sft_lora_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the LoRA model for SFT.
Since LoRA is currently not supported for SFT, this option is not utilized at present.</p></li>
<li><p><strong>model</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Configuration for model runtime.</p></li>
<li><p><strong>allocation</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – Configuration for device allocation and parallelism.</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="#realhf.PairedComparisonDatasetConfig" title="realhf.PairedComparisonDatasetConfig"><em>PairedComparisonDatasetConfig</em></a>) – Configuration for the dataset.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.DPOConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">DPOConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">experiment_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trial_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'slurm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'dev'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">image_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_retries:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_worker_error:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'pipe_model'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_use_cache:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_nodes:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_gpus_per_node:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nodelist:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_clear_freq:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exp_ctrl:</span> <span class="pre">~realhf.api.core.system_api.ExperimentSaveEvalControl</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_sft_lora:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sft_lora_path:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">actor:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">actor_train:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref_inf:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset:</span> <span class="pre">~realhf.api.quickstart.dataset.PairedComparisonDatasetConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">beta:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.1</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.DPOConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for Direct Preference Optimization (DPO) experiments.</p>
<p>This class is a subclass of <a class="reference internal" href="#realhf.CommonExperimentConfig" title="realhf.CommonExperimentConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommonExperimentConfig</span></code></a>,
so all CLI options from the base class are available.</p>
<p>Note that runtime evaluation is not implemented for DPO.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>is_sft_lora</strong> (<em>bool</em>) – Whether LoRA was used for SFT.
If LoRA was used, the saved SFT model should only contain LoRA parameters.
Since LoRA is currently not supported for SFT, this option is not utilized at present.</p></li>
<li><p><strong>sft_lora_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the LoRA model for SFT.
Since LoRA is currently not supported for SFT, this option is not utilized at present.</p></li>
<li><p><strong>actor</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the primary LLM.</p></li>
<li><p><strong>ref</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the reference LLM.
This model is used only for inference to provide KL regularization.
In ReaL, this model is automatically offloaded to CPU,
making DPO training as efficient as training a single LLM.</p></li>
<li><p><strong>actor_train</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – Device allocation and parallelism configuration for training on the primary LLM.</p></li>
<li><p><strong>ref_inf</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – Device allocation and parallelism configuration for inference on the reference LLM.
This configuration can differ from the training allocation.
A larger data parallel degree with additional pipelining can improve inference performance.</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="#realhf.PairedComparisonDatasetConfig" title="realhf.PairedComparisonDatasetConfig"><em>PairedComparisonDatasetConfig</em></a>) – Configuration for the dataset, which is the same as for reward modeling.</p></li>
<li><p><strong>beta</strong> (<em>float</em>) – KL regularization coefficient.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.GenerationHyperparameters">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">GenerationHyperparameters</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_new_tokens</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_new_tokens</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">greedy</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">top_p</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.9</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">top_k</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">200</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">temperature</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_cuda_graph</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">force_cudagraph_recapture</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">force_no_logits_mask</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.GenerationHyperparameters" title="Link to this definition">¶</a></dt>
<dd><p>Generation hyperparameters.</p>
<p>We implement a customized generation function instead of using
HuggingFace’s to support pipelined generation. As a result, advanced
generation techniques like diversity-promoting sampling or
repetition penalty are not supported during PPO training. However,
we do not find this to be a problem in practice. Increasing the
sampling temperature and enabling top-k/top-p sampling can produce
effective models.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>max_new_tokens</strong> (<em>int</em>) – The maximum number of new tokens to generate.</p></li>
<li><p><strong>min_new_tokens</strong> (<em>int</em>) – The minimum number of new tokens to generate.</p></li>
<li><p><strong>greedy</strong> (<em>bool</em>) – Whether to use greedy decoding.</p></li>
<li><p><strong>top_k</strong> (<em>int</em>) – The number of highest probability tokens to keep.</p></li>
<li><p><strong>top_p</strong> (<em>float</em>) – The cumulative probability of the highest probability
tokens to keep.</p></li>
<li><p><strong>temperature</strong> (<em>float</em>) – The temperature of the sampling process.</p></li>
<li><p><strong>use_cuda_graph</strong> (<em>bool</em>) – Whether to use CUDA graph to reduce kernel
launch overhead during generation.</p></li>
<li><p><strong>force_cudagraph_recapture</strong> (<em>bool</em>) – Whether to capture the CUDA graph
every time <cite>generate</cite> is called, even if the graph has been captured
before. This will introduce minor overhead but will release the
kvcache when not running generation.</p></li>
<li><p><strong>force_no_logits_mask</strong> (<em>bool</em>) – Whether to omit the logits mask. The logits
mask is produced when using top-k or top-p sampling, marking tokens
that are filtered out. This mask is used by the reference model and
the actor model during training to align inferred logits with those
during generation and produce accurate KLs. Using the logits mask with
top-k/top-p sampling greatly improves the stability of PPO training
by narrowing the action space. However, this benefit comes at the cost
of additional GPU memory usage. If this option is set to True, the
logits mask will be omitted to save GPU memory, which may lead to a
decrease in learning performance.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.PPOHyperparameters">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">PPOHyperparameters</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">gen:</span> <span class="pre">~realhf.api.core.model_api.GenerationHyperparameters</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ppo_n_minibatches:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">4</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kl_ctl:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">discount:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gae_lambda:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eps_clip:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_eps_clip:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_reward_clip:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">20.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reward_output_scaling:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reward_output_bias:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">early_stop_imp_ratio:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">5.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_adaptive_kl_ctl:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">adv_norm:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_norm:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_norm_type:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'exp'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_norm_beta:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">0.99995</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_norm_eps:</span> <span class="pre">float</span> <span class="pre">=</span> <span class="pre">1e-05</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.PPOHyperparameters" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for PPO hyperparameters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>gen</strong> (<a class="reference internal" href="#realhf.GenerationHyperparameters" title="realhf.GenerationHyperparameters"><em>GenerationHyperparameters</em></a>) – Hyperparameters for generation.</p></li>
<li><p><strong>ppo_n_minibatches</strong> (<em>int</em>) – Number of minibatches in each PPO update.</p></li>
<li><p><strong>kl_ctl</strong> (<em>float</em>) – Coefficient for KL divergence rewards.</p></li>
<li><p><strong>discount</strong> (<em>float</em>) – Discount factor for future rewards.</p></li>
<li><p><strong>gae_lambda</strong> (<em>float</em>) – Lambda factor used in Generalized Advantage Estimation (GAE).</p></li>
<li><p><strong>eps_clip</strong> (<em>float</em>) – Clipping factor for the PPO actor probability ratio.</p></li>
<li><p><strong>value_eps_clip</strong> (<em>float</em>) – Clipping factor for the PPO value function.</p></li>
<li><p><strong>max_reward_clip</strong> (<em>float</em>) – Maximum reward value after clipping.</p></li>
<li><p><strong>reward_output_scaling</strong> (<em>float</em>) – Scaling factor for the reward model output.</p></li>
<li><p><strong>reward_output_bias</strong> (<em>float</em>) – Bias for the reward model output.
The output of the reward model will be clipped to the range
[-max_reward_clip, max_reward_clip] after applying the scaling and bias:
CLIP((x - bias) * scaling, -max_reward_clip, max_reward_clip).</p></li>
<li><p><strong>early_stop_imp_ratio</strong> (<em>float</em>) – Maximum value of the importance ratio. PPO updates
will be early stopped if the ratio exceeds this value.</p></li>
<li><p><strong>use_adaptive_kl_ctl</strong> (<em>bool</em>) – Whether to use an adaptive KL divergence coefficient.</p></li>
<li><p><strong>adv_norm</strong> (<em>bool</em>) – Whether to normalize the advantage estimates.</p></li>
<li><p><strong>value_norm</strong> (<em>bool</em>) – Whether to denormalize values and normalize return predictions.</p></li>
<li><p><strong>value_norm_type</strong> (<em>str</em>) – Type of value normalization.
Can be either “exp” for exponential moving average or “ma” for moving average.</p></li>
<li><p><strong>value_norm_beta</strong> (<em>float</em>) – Exponential decay factor for the exponential moving average.</p></li>
<li><p><strong>value_norm_eps</strong> (<em>float</em>) – Epsilon factor in the denominator of the exponential moving average.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.PPOConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">PPOConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">experiment_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trial_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'slurm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'dev'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">image_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_retries:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_worker_error:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'pipe_model'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_use_cache:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_nodes:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_gpus_per_node:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nodelist:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_clear_freq:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exp_ctrl:</span> <span class="pre">~realhf.api.core.system_api.ExperimentSaveEvalControl</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_sft_lora:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sft_lora_path:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_rew_lora:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rew_lora_path:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rew_head_path:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">actor:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">critic:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rew:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">actor_train:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">critic_train:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">actor_gen:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">critic_inf:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rew_inf:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref_inf:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset:</span> <span class="pre">~realhf.api.quickstart.dataset.PromptOnlyDatasetConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ppo:</span> <span class="pre">~realhf.experiments.common.ppo_exp.PPOHyperparameters</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.PPOConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for PPO experiments.</p>
<p>This class is a subclass of <a class="reference internal" href="#realhf.CommonExperimentConfig" title="realhf.CommonExperimentConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommonExperimentConfig</span></code></a>,
so all CLI options from the base class are available.</p>
<p>Note that runtime evaluation is not implemented for PPO.</p>
<p>The RLHF process involves four distinct models with independent parameters and six
<em>model function calls</em>:</p>
<p>The four models are:</p>
<ul class="simple">
<li><p>Actor: The primary LLM that generates text.</p></li>
<li><p>Critic: The value function that estimates the value of a state.</p></li>
<li><p>Ref: The reference LLM that provides KL regularization.</p></li>
<li><p>Rew: The reward model that provides reward signals.</p></li>
</ul>
<p>The six model function calls and their dependencies are:</p>
<ul class="simple">
<li><p>Rollout: Generate text from the actor model.</p></li>
<li><p>InfReward: Infer rewards from the reward model based on generated text.</p></li>
<li><p>InfRef: Infer log probabilities from the reference model based on generated text.</p></li>
<li><p>InfValues: Infer values from the critic model based on generated text.</p></li>
<li><p>TrainActor: Train the actor model using generated text, rewards, values, and reference log probabilities.</p></li>
<li><p>TrainCritic: Train the critic model using generated text, rewards, values, and reference log probabilities.</p></li>
</ul>
<p>This class manages these dependencies internally. Users should specify
the runtime configurations of the models and the allocations for each model function call.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>is_sft_lora</strong> (<em>bool</em>) – Whether LoRA was used for SFT.
If LoRA was used, the saved SFT model should only contain LoRA parameters.
Since LoRA is currently not supported for SFT, this option is not utilized at present.</p></li>
<li><p><strong>sft_lora_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the LoRA model for SFT.
Since LoRA is currently not supported for SFT, this option is not utilized at present.</p></li>
<li><p><strong>is_rw_lora</strong> (<em>bool</em>) – Whether LoRA was used for reward modeling.
If LoRA was used, the saved reward model should only contain LoRA parameters
and the new reward head.
Since LoRA is currently not supported for reward modeling, this option is not utilized at present.</p></li>
<li><p><strong>rw_lora_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the LoRA model for reward modeling.
Since LoRA is currently not supported for reward modeling, this option is not utilized at present.</p></li>
<li><p><strong>rew_head_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the new reward head for reward modeling.
Since LoRA is currently not supported for reward modeling, this option is not utilized at present.</p></li>
<li><p><strong>actor</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the primary LLM.</p></li>
<li><p><strong>critic</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the critic model of PPO.</p></li>
<li><p><strong>ref</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the reference LLM.</p></li>
<li><p><strong>rew</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the reward LLM.</p></li>
<li><p><strong>actor_train</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – <a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">MFCConfig</span></code></a> for the TrainActor function call.</p></li>
<li><p><strong>critic_train</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – <a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">MFCConfig</span></code></a> for the TrainCritic function call.</p></li>
<li><p><strong>actor_gen</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – <a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">MFCConfig</span></code></a> for the Rollout function call.</p></li>
<li><p><strong>critic_inf</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – <a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">MFCConfig</span></code></a> for the InfValues function call.</p></li>
<li><p><strong>rew_inf</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – <a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">MFCConfig</span></code></a> for the InfReward function call.</p></li>
<li><p><strong>ref_inf</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – <a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">MFCConfig</span></code></a> for the InfRef function call.</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="#realhf.PromptOnlyDatasetConfig" title="realhf.PromptOnlyDatasetConfig"><em>PromptOnlyDatasetConfig</em></a>) – Configuration for the dataset.</p></li>
<li><p><strong>ppo</strong> (<a class="reference internal" href="#realhf.PPOHyperparameters" title="realhf.PPOHyperparameters"><em>PPOHyperparameters</em></a>) – Configuration for the PPO algorithm.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.GenerationConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">GenerationConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">experiment_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trial_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'???'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'slurm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'dev'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">image_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'disabled'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recover_retries:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_worker_error:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_mode:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'pipe_model'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation_use_cache:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_nodes:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_gpus_per_node:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nodelist:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seed:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_clear_freq:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exp_ctrl:</span> <span class="pre">~realhf.api.core.system_api.ExperimentSaveEvalControl</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model:</span> <span class="pre">~realhf.api.quickstart.model.ModelTrainEvalConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gen:</span> <span class="pre">~realhf.api.core.model_api.GenerationHyperparameters</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset:</span> <span class="pre">~realhf.api.quickstart.dataset.PromptOnlyDatasetConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allocation:</span> <span class="pre">~realhf.api.quickstart.device_mesh.MFCConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_file:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'output.jsonl'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.GenerationConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for generation experiments.</p>
<p>This class is a subclass of <a class="reference internal" href="#realhf.CommonExperimentConfig" title="realhf.CommonExperimentConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommonExperimentConfig</span></code></a>,
so all CLI options from the base class are available.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> (<a class="reference internal" href="#realhf.ModelTrainEvalConfig" title="realhf.ModelTrainEvalConfig"><em>ModelTrainEvalConfig</em></a>) – Runtime configuration for the model.</p></li>
<li><p><strong>gen_params</strong> (<a class="reference internal" href="#realhf.GenerationHyperparameters" title="realhf.GenerationHyperparameters"><em>GenerationHyperparameters</em></a>) – Hyperparameters for generation.</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="#realhf.PromptOnlyDatasetConfig" title="realhf.PromptOnlyDatasetConfig"><em>PromptOnlyDatasetConfig</em></a>) – Configuration for the dataset.</p></li>
<li><p><strong>allocation</strong> (<a class="reference internal" href="#realhf.MFCConfig" title="realhf.MFCConfig"><em>MFCConfig</em></a>) – Configuration for device allocation and parallelism.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="model-configurations">
<h2>Model Configurations<a class="headerlink" href="#model-configurations" title="Link to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelFamily">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelFamily</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">_class</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_critic</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelFamily" title="Link to this definition">¶</a></dt>
<dd><p>An identifier for the HF model type, such as llama, gpt2, etc.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>_class</strong> (<em>str</em>) – The class of the model, e.g., “llama”. This is the registered
name in the <code class="docutils literal notranslate"><span class="pre">register_hf_family</span></code> function. Please refer to the files
in <code class="docutils literal notranslate"><span class="pre">realhf/api/from_hf</span></code> for a list of all supported models.</p></li>
<li><p><strong>size</strong> (<em>int</em>) – The size of the model. This parameter is only used by the <code class="docutils literal notranslate"><span class="pre">search</span></code>
allocation mode and will be ignored otherwise.</p></li>
<li><p><strong>is_critic</strong> (<em>bool</em>) – Indicates whether the model is a critic or reward model,
as opposed to a standard LLM.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelTrainEvalConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelTrainEvalConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type:</span> <span class="pre">~realhf.api.core.config.ModelFamily</span> <span class="pre">=</span> <span class="pre">llama-7</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">backend:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'megatron'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lora:</span> <span class="pre">~realhf.api.quickstart.model.LoRAConfig</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gradient_checkpointing:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">enable_fp16:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">enable_bf16:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offload:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zero_stage:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optimizer:</span> <span class="pre">~realhf.api.quickstart.model.OptimizerConfig</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">init_from_scratch:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">init_critic_from_actor:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelTrainEvalConfig" title="Link to this definition">¶</a></dt>
<dd><p>Runtime configuration for models (or LLMs) in ReaL.</p>
<p>We use a customized model class instead of HuggingFace’s. This customized model has
the following highlights:</p>
<ol class="arabic simple">
<li><p>Support for 3D parallelism and sequence parallelism.</p></li>
<li><p>Support for flash attention during both training and generation.</p></li>
<li><p>Input sequences are packed into a single 1D tensor to save GPU memory and improve efficiency.</p></li>
</ol>
<p>Consequently, each HuggingFace model of interest needs to be manually converted to this
customized model. Implemented models can be found in the <code class="docutils literal notranslate"><span class="pre">realhf/api/from_hf/</span></code> directory.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>type</strong> (<a class="reference internal" href="#realhf.ModelFamily" title="realhf.ModelFamily"><em>ModelFamily</em></a>) – Model family type, e.g., llama, qwen2, etc.</p></li>
<li><p><strong>backend</strong> (<em>str</em>) – Backend for training. Currently, only “megatron” and “deepspeed” are supported.
Use “deepspeed” for offloading parameters or optimizer states, and “megatron” for
parameter reallocation.</p></li>
<li><p><strong>path</strong> (<em>str</em>) – Path of the HuggingFace checkpoint.</p></li>
<li><p><strong>lora</strong> (<em>Optional</em><em>[</em><em>LoRAConfig</em><em>]</em>) – Whether to use LoRA (Low-Rank Adaptation).</p></li>
<li><p><strong>gradient_checkpointing</strong> (<em>bool</em>) – Whether to use gradient checkpointing to save memory.</p></li>
<li><p><strong>enable_fp16</strong> (<em>bool</em>) – Whether to use fp16 precision.</p></li>
<li><p><strong>enable_bf16</strong> (<em>bool</em>) – Whether to use bf16 precision. Mutually exclusive with fp16.</p></li>
<li><p><strong>offload</strong> (<em>bool</em>) – Whether to offload model parameters to CPU. Only valid for the DeepSpeed backend.</p></li>
<li><p><strong>parallel</strong> (<a class="reference internal" href="#realhf.ParallelismConfig" title="realhf.ParallelismConfig"><em>ParallelismConfig</em></a>) – Configuration for parallelism.</p></li>
<li><p><strong>zero_stage</strong> (<em>int</em>) – Stage of ZeRO optimization. Should be one of 0, 1, 2, or 3.</p></li>
<li><p><strong>optimizer</strong> (<em>Optional</em><em>[</em><a class="reference internal" href="#realhf.OptimizerConfig" title="realhf.OptimizerConfig"><em>OptimizerConfig</em></a><em>]</em>) – Configuration for the optimizer.</p></li>
<li><p><strong>init_critic_from_actor</strong> (<em>bool</em>) – Whether to initialize a critic/reward model from a saved LM checkpoint.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.OptimizerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">OptimizerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'empty'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lr</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1e-05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_decay</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">beta1</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.9</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">beta2</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.95</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eps</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1e-05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_lr_ratio</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lr_scheduler_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'cosine'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">warmup_steps_proportion</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.02</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offload</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.OptimizerConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for the optimizer.</p>
<p>For models that will not be trained, the optimizer type should be
set to “empty”.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>type</strong> (<em>str</em>) – Type of optimizer. Currently, only “adam” and “empty”
optimizers are supported.</p></li>
<li><p><strong>lr</strong> (<em>float</em>) – Learning rate.</p></li>
<li><p><strong>weight_decay</strong> (<em>float</em>) – Weight decay.</p></li>
<li><p><strong>beta1</strong> (<em>float</em>) – Adam beta1 parameter.</p></li>
<li><p><strong>beta2</strong> (<em>float</em>) – Adam beta2 parameter.</p></li>
<li><p><strong>eps</strong> (<em>float</em>) – Adam epsilon parameter in the denominator.</p></li>
<li><p><strong>min_lr_ratio</strong> (<em>float</em>) – Minimum learning rate ratio after learning rate
annealing. Should be in the interval [0.0, 1.0].</p></li>
<li><p><strong>lr_scheduler_type</strong> (<em>str</em>) – Type of learning rate scheduler. One of
“linear”, “cosine”, or “constant”.</p></li>
<li><p><strong>warmup_steps_proportion</strong> (<em>float</em>) – Proportion of total training steps
allocated for warming up. Should be in the interval [0.0, 1.0].</p></li>
<li><p><strong>offload</strong> (<em>bool</em>) – Whether to offload the optimizer to CPU. Only valid
for the DeepSpeed backend.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ParallelismConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ParallelismConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_parallel_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pipeline_parallel_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data_parallel_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_sequence_parallel</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ParallelismConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for 3D parallelism.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model_parallel_size</strong> (<em>int</em>) – Size of tensor-model parallelism.</p></li>
<li><p><strong>pipeline_parallel_size</strong> (<em>int</em>) – Number of pipeline parallelism
stages.</p></li>
<li><p><strong>data_parallel_size</strong> (<em>int</em>) – Data parallelism size for ZeRO
optimization.</p></li>
<li><p><strong>use_sequence_parallel</strong> (<em>bool</em>) – Whether to use sequence parallelism in
Megatron in combination with tensor-model parallelism.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.MFCConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">MFCConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">n_mbs:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">parallel:</span> <span class="pre">~realhf.api.quickstart.model.ParallelismConfig</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">device_mesh:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.MFCConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for a single MFC.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>n_mbs</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – Number of micro-batches when executing this MFC. Refer
to MFCDef for details.</p></li>
<li><p><strong>parallel</strong> (<a class="reference internal" href="#realhf.ParallelismConfig" title="realhf.ParallelismConfig"><em>ParallelismConfig</em></a>) – Configuration for the parallelism strategy. This is
used only for manual allocation.</p></li>
<li><p><strong>device_mesh</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – String representation of the device mesh. If it
consists of multiple nodes, it should be formatted as a SLURM
nodelist, e.g., node[01-02] or node01,node02. If it represents a
slice on a single node, it should occupy 1, 2, 4, or 8
contiguous GPUs on the node. In this case, the string
representation is similar to an MPI hostfile, e.g.,
“node01:0,1,2,3” for the first 4 GPUs on node01. This is used
only for manual allocation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ReaLModelConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ReaLModelConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">n_layers</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_kv_heads</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_q_heads</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hidden_dim</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">intermediate_dim</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vocab_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">head_dim</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_positions</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">embd_pdrop</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">resid_pdrop</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">attn_pdrop</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">layer_norm_epsilon</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1e-05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">activation_function</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'gelu'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale_attn_by_inverse_layer_idx</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale_attn_weights</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_attention_bias</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_attn_proj_bias</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">layer_norm_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mlp_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">apply_rotary</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rotary_base</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">10000.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rotary_interleaved</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rotary_scaling</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rotary_scaling_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalize_embed</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">abs_position_embedding_offset</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">do_layernorm_before</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tied_embedding</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sliding_window</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">moe</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ReaLMoEConfig</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_critic</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ReaLModelConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for the ReaLModel.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>n_layers</strong> (<em>int</em>) – The number of transformer blocks.</p></li>
<li><p><strong>n_kv_heads</strong> (<em>int</em>) – The number of key-value attention heads.</p></li>
<li><p><strong>n_q_heads</strong> (<em>int</em>) – The number of query attention heads.</p></li>
<li><p><strong>head_dim</strong> (<em>int</em><em> or </em><em>None</em>) – The dimension of each attention head.
If None, it defaults to hidden_dim // n_q_heads.
If specified, the query layer will have the shape
(hidden_dim, head_dim * n_q_heads).</p></li>
<li><p><strong>hidden_dim</strong> (<em>int</em>) – The hidden dimension of the transformer block.</p></li>
<li><p><strong>intermediate_dim</strong> (<em>int</em>) – The dimension of the intermediate layer in the MLP.</p></li>
<li><p><strong>vocab_size</strong> (<em>int</em>) – The vocabulary size.</p></li>
<li><p><strong>n_positions</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The maximum context length. Can be None for
rotary embedding, where the context length is determined during runtime.</p></li>
<li><p><strong>embd_pdrop</strong> (<em>float</em>) – The dropout probability for the embedding layer.</p></li>
<li><p><strong>resid_pdrop</strong> (<em>float</em>) – The dropout probability for the residual connections.</p></li>
<li><p><strong>attn_pdrop</strong> (<em>float</em>) – The dropout probability for the attention weights.</p></li>
<li><p><strong>layer_norm_epsilon</strong> (<em>float</em>) – The epsilon value for layer normalization.</p></li>
<li><p><strong>activation_function</strong> (<em>str</em>) – The activation function for the MLP.</p></li>
<li><p><strong>scale_attn_by_inverse_layer_idx</strong> (<em>bool</em>) – Whether to scale the attention weights
by the inverse of the layer index.</p></li>
<li><p><strong>use_attention_bias</strong> (<em>bool</em>) – Whether to use bias for QKV layers.</p></li>
<li><p><strong>use_attn_proj_bias</strong> (<em>bool</em>) – Whether to use bias for the attention projection layer.</p></li>
<li><p><strong>layer_norm_type</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – The type of layer normalization. Can be None, “rms”, or “gemma”.</p></li>
<li><p><strong>mlp_type</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – The type of the MLP. Can be None, “llama”, or “moe”.</p></li>
<li><p><strong>apply_rotary</strong> (<em>bool</em>) – Whether to apply rotary embedding.</p></li>
<li><p><strong>rotary_base</strong> (<em>float</em>) – The exponential base for the rotary embedding.</p></li>
<li><p><strong>rotary_interleaved</strong> (<em>bool</em>) – Whether to use interleaved rotary embedding.</p></li>
<li><p><strong>rotary_scaling</strong> (<em>Optional</em><em>[</em><em>float</em><em>]</em>) – The scaling factor for the rotary embedding.</p></li>
<li><p><strong>rotary_scaling_type</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – The type of scaling for the rotary embedding.</p></li>
<li><p><strong>normalize_embed</strong> (<em>bool</em>) – Whether to normalize the embeddings
before passing them through the transformer blocks. Used by Gemma.</p></li>
<li><p><strong>abs_position_embedding_offset</strong> (<em>int</em>) – The offset for the absolute position embedding.
Used by OPT, but OPT is currently not supported.</p></li>
<li><p><strong>do_layernorm_before</strong> (<em>bool</em>) – Whether to apply layer normalization before the attention
rather than after. Used by OPT, but OPT is currently not supported.</p></li>
<li><p><strong>tied_embedding</strong> (<em>bool</em>) – Whether to share the embeddings and output weights.
Used by models like GPT-2 and Gemma.</p></li>
<li><p><strong>sliding_window</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The sliding window size for the attention.
Currently a placeholder and not supported.</p></li>
<li><p><strong>moe</strong> (<em>Optional</em><em>[</em><em>ReaLMoEConfig</em><em>]</em>) – Configuration for MoE models, only effective when mlp_type=”moe”.</p></li>
<li><p><strong>is_critic</strong> (<em>bool</em>) – Whether the model is a critic model.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="dataset-configurations">
<h2>Dataset Configurations<a class="headerlink" href="#dataset-configurations" title="Link to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.PromptAnswerDatasetConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">PromptAnswerDatasetConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">train_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_seqlen</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1024</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">train_bs_n_seqs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_bs_n_seqs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pad_to_max_length</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.PromptAnswerDatasetConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for datasets used in Supervised Fine-Tuning (SFT).</p>
<p>The raw data must be in a JSON or JSONL file format, where each entry is a dictionary
with the keys <cite>prompt</cite> and <cite>answer</cite>. Both <cite>prompt</cite> and <cite>answer</cite> must be strings.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>train_path</strong> (<em>str</em>) – Path to the training dataset.</p></li>
<li><p><strong>valid_path</strong> (<em>str</em>) – Path to the validation dataset.</p></li>
<li><p><strong>max_seqlen</strong> (<em>int</em>) – Maximum sequence length (prompt + answer). Sequences longer than
this will be truncated.</p></li>
<li><p><strong>train_bs_n_seqs</strong> (<em>int</em>) – Number of sequences in each batch during training.</p></li>
<li><p><strong>valid_bs_n_seqs</strong> (<em>int</em>) – Number of sequences in each batch during validation.</p></li>
<li><p><strong>pad_to_max_length</strong> (<em>bool</em>) – Whether to pad sequences to the maximum length. If True,
all mini-batches created by the DP balanced partitioning algorithm will have
the same number of tokens, making MFC time predictable. This option is used
only for benchmarking purposes.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.PairedComparisonDatasetConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">PairedComparisonDatasetConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">train_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_pairs_per_prompt</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_seqlen</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1024</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">train_bs_n_seqs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_bs_n_seqs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.PairedComparisonDatasetConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for datasets used in paired-comparison reward modeling,
DPO, and SimPO.</p>
<p>The raw data must be in a JSON or JSONL file format, where each entry is a dictionary
with the keys <cite>prompt</cite>, <cite>pos_answers</cite>, and <cite>neg_answers</cite>. <cite>prompt</cite> is a string, while
<cite>pos_answers</cite> and <cite>neg_answers</cite> are lists of strings. The lists must have the same length.</p>
<p>The raw dataset may contain multiple answer pairs for each prompt. In each epoch, we will
randomly sample <cite>max_pairs_per_prompt</cite> answer pairs for each prompt, so the maximum batch
size (in terms of the number of sequences) per step is <cite>train_bs_n_seqs</cite> multiplied by
<cite>max_pairs_per_prompt</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>train_path</strong> (<em>str</em>) – Path to the training dataset.</p></li>
<li><p><strong>valid_path</strong> (<em>str</em>) – Path to the evaluation dataset.</p></li>
<li><p><strong>max_pairs_per_prompt</strong> (<em>int</em>) – Maximum number of answer pairs per prompt.</p></li>
<li><p><strong>max_seqlen</strong> (<em>int</em>) – Maximum sequence length (prompt + answers). Sequences longer than
this will be truncated.</p></li>
<li><p><strong>train_bs_n_seqs</strong> (<em>int</em>) – Number of sequences in each batch during training.</p></li>
<li><p><strong>valid_bs_n_seqs</strong> (<em>int</em>) – Number of sequences in each batch during validation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.PromptOnlyDatasetConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">PromptOnlyDatasetConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_prompt_len</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">train_bs_n_seqs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">256</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pad_to_max_length</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.PromptOnlyDatasetConfig" title="Link to this definition">¶</a></dt>
<dd><p>Configuration for datasets used in PPO RLHF.</p>
<p>The raw data must be in a JSON or JSONL file format, where each entry is a dictionary
with a single key called <cite>prompt</cite>, which is a string.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>str</em>) – Path to the dataset.</p></li>
<li><p><strong>max_prompt_len</strong> (<em>int</em>) – Maximum length of the prompt. Prompts longer than this will
be truncated.</p></li>
<li><p><strong>train_bs_n_seqs</strong> (<em>int</em>) – Number of prompts in each batch.</p></li>
<li><p><strong>pad_to_max_length</strong> (<em>bool</em>) – Whether to pad prompts to the maximum length. If True,
all mini-batches created by the DP balanced partitioning algorithm will have
the same number of tokens, making MFC time predictable. This option is used
only for benchmarking purposes.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="data-structure-for-interfaces-and-datasets">
<h2>Data Structure for Interfaces and Datasets<a class="headerlink" href="#data-structure-for-interfaces-and-datasets" title="Link to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.SequenceSample">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">SequenceSample</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">keys:</span> <span class="pre">~typing.Set[str],</span> <span class="pre">trailing_shapes:</span> <span class="pre">~typing.Dict[str,</span> <span class="pre">~torch.Size</span> <span class="pre">|</span> <span class="pre">~typing.Tuple</span> <span class="pre">|</span> <span class="pre">None],</span> <span class="pre">dtypes:</span> <span class="pre">~typing.Dict[str,</span> <span class="pre">~torch.dtype</span> <span class="pre">|</span> <span class="pre">None],</span> <span class="pre">ids:</span> <span class="pre">~typing.List[~typing.Hashable],</span> <span class="pre">seqlens:</span> <span class="pre">~typing.Dict[str,</span> <span class="pre">~typing.List[~typing.List[int]]],</span> <span class="pre">data:</span> <span class="pre">~typing.Dict[str,</span> <span class="pre">~torch.Tensor</span> <span class="pre">|</span> <span class="pre">None]</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None,</span> <span class="pre">metadata:</span> <span class="pre">~typing.Dict[str,</span> <span class="pre">~typing.List[~typing.Any]]</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample" title="Link to this definition">¶</a></dt>
<dd><p>The data structure used to represent sequence data.</p>
<p>Each piece of data is assumed to have several “keys” (like a dictionary),
with each key potentially corresponding to multiple sequences.</p>
<p>For example, when running PPO, multiple responses can be generated for each prompt.
If there are 2 prompts, each with 3 responses, the batch might look like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt; s = SequenceSample(...)</span>
<span class="go">&gt;&gt;&gt; s.keys</span>
<span class="go">{&#39;resp&#39;, &#39;prompt&#39;}</span>
<span class="go">&gt;&gt;&gt; s.seqlens</span>
<span class="go">{&#39;prompt&#39;: [[13], [6]], &#39;resp&#39;: [[6, 17, 15], [13, 15, 13]]}</span>
<span class="go">&gt;&gt;&gt; s.data</span>
<span class="go">{&#39;prompt&#39;: torch.tensor([...]), &#39;resp&#39;: torch.tensor([...])}</span>
</pre></div>
</div>
<p>Key points:</p>
<ul class="simple">
<li><p>Data with different batch indices can have varying lengths (e.g., the first prompt has a length of 13
while the second has a length of 6).</p></li>
<li><p>A key (e.g., “response”) can correspond to multiple sequences with different lengths.
Additionally, the number of sequences for each key can differ from the number of sequences for the data.
For example, the first prompt may have 2 responses, and the second may have 3.</p></li>
<li><p>Regardless of the batch size or the number of sequences stored for each key,
the data is concatenated into a 1D tensor. The outer dimension represents the batch size,
and the inner dimension represents the number of sequences for the key.</p></li>
</ul>
<p>This data structure facilitates easy gathering, splitting,
and transferring of non-padded batches between different GPUs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>keys</strong> (<em>Set</em><em>[</em><em>str</em><em>]</em>) – The keys of the data.</p></li>
<li><p><strong>trailing_shapes</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>torch.Size</em><em> | </em><em>Tuple</em><em> | </em><em>None</em><em>]</em>) – The trailing shapes of the data,
excluding the first dimension, which must be the sequence length.
Used to construct the receiving buffer for data transfer.</p></li>
<li><p><strong>dtypes</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>torch.dtype</em><em> | </em><em>None</em><em>]</em>) – The types of the data. Used to construct
the receiving buffer for data transfer.</p></li>
<li><p><strong>ids</strong> (<em>List</em><em>[</em><em>Hashable</em><em>]</em>) – Unique identifiers for each piece of data.
Should be provided in the dataset implementation.
Used to append new data to the buffer after a model function call.</p></li>
<li><p><strong>seqlens</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>List</em><em>[</em><em>List</em><em>[</em><em>int</em><em>]</em><em>]</em><em>]</em>) – The sequence lengths of each sequence in the data. For a given key,
this should be a list of lists of integers. The outer list represents the batch size,
while the inner lists represent the sequence lengths for this key.
Python-native lists are used here because (1) pickling torch.Tensor or numpy array is inefficient,
and (2) the size of the inner lists can vary across the batch, making 2D arrays impractical.</p></li>
<li><p><strong>data</strong> (<em>Optional</em><em>[</em><em>Dict</em><em>[</em><em>str</em><em>, </em><em>torch.Tensor</em><em> | </em><em>None</em><em>]</em><em>]</em>) – The actual concatenated data. If this is None,
the sample is a metadata-only sample used by the master worker.
The specification of the data should be consistent with the seqlens,
dtypes, and trailing_shapes.</p></li>
<li><p><strong>metadata</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>List</em><em>[</em><em>Any</em><em>]</em><em>]</em>) – Metadata for the sample. It should be a
dictionary of lists, provided in the dataset implementation.
Note that adding metadata can slow down data transfer.</p></li>
</ul>
</dd>
</dl>
<dl class="py property">
<dt class="sig sig-object py" id="realhf.SequenceSample.bs">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">bs</span></span><a class="headerlink" href="#realhf.SequenceSample.bs" title="Link to this definition">¶</a></dt>
<dd><p>The batch size or the number of data pieces in the sample.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.cuda">
<span class="sig-name descname"><span class="pre">cuda</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.cuda" title="Link to this definition">¶</a></dt>
<dd><p>Move the data to GPU inplace.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.disable_validation">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">disable_validation</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.disable_validation" title="Link to this definition">¶</a></dt>
<dd><p>Disable the expensive pydantic validation within this context.</p>
<p>Used to accelerate gather/split/transfer operations since we
have ensured that the data created in datasets and interfaces
are valid.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.from_default">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">from_default</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seqlens</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">int</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ids</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">Hashable</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Tensor</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.from_default" title="Link to this definition">¶</a></dt>
<dd><p>Construct a <cite>SequenceSample</cite> object from default parameters.</p>
<p>This helper function is intended for cases where each piece of data has
a single sequence length (e.g., a single response for each prompt).
The sequence lengths for different keys are resolved automatically
according to the rules in <code class="docutils literal notranslate"><span class="pre">_resolve_seqlen_from_key</span></code>. While this function
can reduce boilerplate code, it may introduce potential bugs, so it should
be used with caution.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seqlens</strong> (<em>List</em><em>[</em><em>int</em><em>]</em>) – The sequence lengths of each piece of data. This represents
the length of the main attribute (e.g., <cite>packed_input_ids</cite>). Sequence lengths
for other attributes (e.g., rewards and logprobs) are computed from this parameter.
It is <strong>NOT</strong> the actual length of rewards or logprobs even if it is the only key
in the data.</p></li>
<li><p><strong>ids</strong> (<em>List</em><em>[</em><em>Hashable</em><em>]</em>) – Unique identifiers for each piece of data.</p></li>
<li><p><strong>data</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>torch.Tensor</em><em>]</em>) – The actual data.</p></li>
<li><p><strong>metadata</strong> (<em>Optional</em><em>[</em><em>Dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>]</em><em>]</em>) – Metadata for the sample. Should be a dictionary where each value
is a list with a length equal to the number of sequence lengths.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.gather">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">gather</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">samples</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keys</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.gather" title="Link to this definition">¶</a></dt>
<dd><p>Gather a list of SequenceSample objects into a single batch.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>samples</strong> (<em>List</em><em>[</em><a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a><em>]</em>) – A list of SequenceSample objects to be gathered.</p></li>
<li><p><strong>keys</strong> (<em>Optional</em><em>[</em><em>List</em><em>[</em><em>str</em><em>]</em><em>]</em>) – The keys to be gathered. Only a subset of keys can
be gathered. If None, the keys from the first sample will be
used.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.get_split_spec">
<span class="sig-name descname"><span class="pre">get_split_spec</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">k</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">SequenceSplitSpec</span></span></span><a class="headerlink" href="#realhf.SequenceSample.get_split_spec" title="Link to this definition">¶</a></dt>
<dd><p>Get the partition specification for splitting the data into <cite>k</cite>
parts using a dynamic programming algorithm to achieve the most
balanced partitioning.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>k</strong> (<em>int</em>) – The number of parts to split the data into.</p></li>
<li><p><strong>key</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – The key to be used for splitting. If None, the key
with the largest total sequence length will be used.</p></li>
<li><p><strong>min_size</strong> (<em>int</em>) – The minimum size of each partition.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A SequenceSplitSpec object representing the
partitioning specification.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>SequenceSplitSpec</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.meta">
<span class="sig-name descname"><span class="pre">meta</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></span><a class="headerlink" href="#realhf.SequenceSample.meta" title="Link to this definition">¶</a></dt>
<dd><p>Create a new SequenceSample that does not contain any data.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.remap_keys_">
<span class="sig-name descname"><span class="pre">remap_keys_</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">remap</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.remap_keys_" title="Link to this definition">¶</a></dt>
<dd><p>Inplace remap keys of the data.</p>
<p>Useful for reusing the same interface implementation in
different algorithms, where the data can be named differently.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.split">
<span class="sig-name descname"><span class="pre">split</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">k</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#realhf.SequenceSample.split" title="Link to this definition">¶</a></dt>
<dd><p>Split the data into <cite>k</cite> parts.</p>
<p>This method uses the specified key or the key with the largest total sequence length
to split the data into <cite>k</cite> parts. The partitioning ensures that each part meets the
minimum size requirement.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>k</strong> (<em>int</em>) – The number of parts to split the data into.</p></li>
<li><p><strong>key</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – The key to use for splitting. If None, the key with the largest
total sequence length will be used.</p></li>
<li><p><strong>min_size</strong> (<em>int</em>) – The minimum size of each partition.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list of <cite>SequenceSample</cite> objects, each representing a part of the split data.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>List[<a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample">SequenceSample</a>]</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.split_with_spec">
<span class="sig-name descname"><span class="pre">split_with_spec</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">SequenceSplitSpec</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#realhf.SequenceSample.split_with_spec" title="Link to this definition">¶</a></dt>
<dd><p>Split the data according to the given spec.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.unpack">
<span class="sig-name descname"><span class="pre">unpack</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.unpack" title="Link to this definition">¶</a></dt>
<dd><p>Unpack a batch of data into individual pieces of data.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.SequenceSample.update_">
<span class="sig-name descname"><span class="pre">update_</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">other</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.SequenceSample.update_" title="Link to this definition">¶</a></dt>
<dd><p>Inplace update data from another SequenceSample.</p>
<p>Used to amend newly produced data after a model function call.</p>
</dd></dl>

</dd></dl>

</section>
<section id="dataflow-graph">
<h2>Dataflow Graph<a class="headerlink" href="#dataflow-graph" title="Link to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.MFCDef">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">MFCDef</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name:</span> <span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_seqs:</span> <span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interface_type:</span> <span class="pre">~realhf.api.core.config.ModelInterfaceType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interface_impl:</span> <span class="pre">~realhf.api.core.config.ModelInterfaceAbstraction</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_name:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">~realhf.api.core.config.ModelName</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_keys:</span> <span class="pre">~typing.Tuple</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_key_remap:</span> <span class="pre">~typing.Dict[str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">str]</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_keys:</span> <span class="pre">~typing.Tuple</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_key_remap:</span> <span class="pre">~typing.Dict[str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">str]</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_mbs:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">balanced_dp:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_return_value:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_type:</span> <span class="pre">~typing.Any</span> <span class="pre">|</span> <span class="pre">~realhf.api.core.config.ModelFamily</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_path:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_G:</span> <span class="pre">~networkx.classes.digraph.DiGraph</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_pre_hooks:</span> <span class="pre">~typing.List[~realhf.api.core.dfg.OffloadHook</span> <span class="pre">|</span> <span class="pre">~realhf.api.core.dfg.ParamReallocHook]</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_post_hooks:</span> <span class="pre">~typing.List[~realhf.api.core.dfg.OffloadHook</span> <span class="pre">|</span> <span class="pre">~realhf.api.core.dfg.ParamReallocHook]</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.MFCDef" title="Link to this definition">¶</a></dt>
<dd><p>A model function call (MFC) object used by the workers.</p>
<p>MFC stands for Model Function Call. This object serves as the interface for
developing new algorithms and will be inserted into an <cite>nx.DiGraph</cite> as nodes.
Edges will be automatically resolved based on input/output keys.</p>
<p>Fields starting with an underscore are filled automatically.</p>
<p><strong>Note:</strong> In the ReaL implementation, the term RPC also refers to MFC.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – The unique identifier for this model function call.</p></li>
<li><p><strong>n_seqs</strong> (<em>int</em>) – The number of sequences to be processed in a batch.</p></li>
<li><p><strong>interface_type</strong> (<em>ModelInterfaceType</em>) – The type of interface used by the node (e.g., generate, train_step).</p></li>
<li><p><strong>interface_impl</strong> (<a class="reference internal" href="#realhf.ModelInterface" title="realhf.ModelInterface"><em>ModelInterface</em></a>) – The actual implementation of the interface when running this node.</p></li>
<li><p><strong>model_name</strong> (<em>str</em><em> or </em><a class="reference internal" href="#realhf.ModelName" title="realhf.ModelName"><em>ModelName</em></a>) – The model identifier used by the node, corresponding to a unique LLM.
The user-provided model name can be a string; the replica ID will be resolved in ReaL.</p></li>
<li><p><strong>input_keys</strong> (<em>Tuple</em>) – Input data keys used to resolve dependencies.</p></li>
<li><p><strong>output_keys</strong> (<em>Tuple</em>) – Output data keys used to resolve dependencies.</p></li>
<li><p><strong>input_key_remap</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>str</em><em>]</em>) – Remap input keys to identifiers recognized by the interface implementation.
Keys are from <cite>input_keys</cite> and values are identifiers known to the interface.</p></li>
<li><p><strong>output_key_remap</strong> (<em>Dict</em><em>[</em><em>str</em><em>, </em><em>str</em><em>]</em>) – Remap output keys to identifiers recognized by MFC.
Keys are identifiers known to the interface, and values are from <cite>output_keys</cite>.</p></li>
<li><p><strong>n_mbs</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The number of micro-batches when executing this MFC. Defaults to 1 if
pipeline parallelism is disabled, or to 2 * pp_size for <cite>train_step</cite> and pp_size
for <cite>generate</cite>/<cite>inference</cite> if pipeline parallelism is enabled.</p></li>
<li><p><strong>balanced_dp</strong> (<em>bool</em>) – Whether to balance data parallelism so that each DP rank receives
exactly <cite>n_seqs // dp_size</cite> sequences. If False, ReaL will partition according to
the number of tokens. This may lead to unbalanced sequence numbers if sequence lengths
are not uniform, but ensures balanced memory usage.</p></li>
<li><p><strong>log_return_value</strong> (<em>bool</em>) – Whether to log the return value of the interface implementation.</p></li>
<li><p><strong>model_type</strong> (<em>Optional</em><em>[</em><a class="reference internal" href="#realhf.ModelFamily" title="realhf.ModelFamily"><em>ModelFamily</em></a><em>]</em>) – The specification of the LLM, e.g., LLaMA-7B. Used by the profiler and
search engine to produce an optimal execution plan. Can be omitted if the search engine
is not used.</p></li>
<li><p><strong>model_path</strong> (<em>Optional</em><em>[</em><em>str</em><em>]</em>) – The path to the model file. Used to get the config for the search engine.
Can be omitted if the search engine is not used.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="system-level-configurations">
<h2>System-Level Configurations<a class="headerlink" href="#system-level-configurations" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These configurations are not supposed to be modified by users. They
are used to help understand the code architecture of ReaL.</p>
</div>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelShardID">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelShardID</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_name:</span> <span class="pre">~realhf.api.core.config.ModelName</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dp_rank:</span> <span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mp_rank:</span> <span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pp_rank:</span> <span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">topo:</span> <span class="pre">~realhf.base.topology.PipeModelDataParallelTopology</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelShardID" title="Link to this definition">¶</a></dt>
<dd><p>The ID of a model shard in a specific model worker.</p>
<p>This ID is essentially a combination of the model name and the 3D
parallelism rank, and can be used as a dictionary key. It represents
the identity of a “model handler”. The master worker maintains a
lookup table mapping the ModelShardID to the model worker index,
which can be a many-to-one mapping. Requests are created with the
ModelShardID; for example, actors with ranks (dp=*, mp=0, pp=0)
should transfer data to the critics. The ModelShardID is then mapped
to the model worker index, and the requests are sent to the
corresponding model workers.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model_name</strong> (<a class="reference internal" href="#realhf.ModelName" title="realhf.ModelName"><em>ModelName</em></a>) – The name of the model.</p></li>
<li><p><strong>dp_rank</strong> (<em>int</em>) – The data parallel rank.</p></li>
<li><p><strong>mp_rank</strong> (<em>int</em>) – The tensor-model parallel rank.</p></li>
<li><p><strong>pp_rank</strong> (<em>int</em>) – The pipeline-model parallel rank.</p></li>
<li><p><strong>topo</strong> (<em>PipeModelDataParallelTopology</em>) – The 3D parallelism topology of this model.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelName">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelName</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">role</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">replica_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelName" title="Link to this definition">¶</a></dt>
<dd><p>A unique identifier for a model.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>role</strong> (<em>str</em>) – The role of the model, e.g., “actor” or “critic”.</p></li>
<li><p><strong>replica_id</strong> (<em>int</em>) – The replica ID of the model. Different replicas
of the same role have the same set of parameters but different
memory locations. For example, if actor generation and training
in PPO use different parallel strategies, they will have the
same role but different replica IDs.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelVersion">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelVersion</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">epoch</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">epoch_step</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">global_step</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelVersion" title="Link to this definition">¶</a></dt>
<dd><p>A version counter.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>epoch</strong> (<em>int</em>) – The current epoch.</p></li>
<li><p><strong>epoch_step</strong> (<em>int</em>) – The current step within the current epoch. A
“step” refers to a traversal of the dataflow graph (DFG), which
may include multiple model update steps depending on the
interface (e.g., PPO mini-batched updates).</p></li>
<li><p><strong>global_step</strong> (<em>int</em>) – The total number of steps since the start of the
experiment.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.Model">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">Model</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name:</span> <span class="pre">~realhf.api.core.config.ModelName</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">module:</span> <span class="pre">~realhf.api.core.model_api.PipelinableEngine</span> <span class="pre">|</span> <span class="pre">~torch.nn.modules.module.Module</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tokenizer:</span> <span class="pre">~transformers.tokenization_utils_fast.PreTrainedTokenizerFast</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">device:</span> <span class="pre">str</span> <span class="pre">|</span> <span class="pre">~torch.device</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype:</span> <span class="pre">~torch.dtype</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version:</span> <span class="pre">~realhf.api.core.model_api.ModelVersion</span> <span class="pre">=</span> <span class="pre">&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ft_spec:</span> <span class="pre">~realhf.api.core.model_api.FinetuneSpec</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.Model" title="Link to this definition">¶</a></dt>
<dd><p>A collection consisting of a neural network, a tokenizer, and metadata
with a unique name.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<a class="reference internal" href="#realhf.ModelName" title="realhf.ModelName"><em>ModelName</em></a>) – The unique name of the model.</p></li>
<li><p><strong>module</strong> (<a class="reference internal" href="#realhf.PipelinableEngine" title="realhf.PipelinableEngine"><em>PipelinableEngine</em></a><em> | </em><em>torch.nn.Module</em>) – The neural network module. Its parameters may be
sharded by tensor or pipeline parallelism.</p></li>
<li><p><strong>tokenizer</strong> (<em>transformers.PreTrainedTokenizerFast</em>) – The tokenizer associated with the model.</p></li>
<li><p><strong>device</strong> (<em>Union</em><em>[</em><em>str</em><em>, </em><em>torch.device</em><em>]</em>) – The device on which to run the model.</p></li>
<li><p><strong>dtype</strong> (<em>Optional</em><em>[</em><em>torch.dtype</em><em>]</em>) – The data type of the model. Defaults to torch.float16
if None.</p></li>
<li><p><strong>version</strong> (<a class="reference internal" href="#realhf.ModelVersion" title="realhf.ModelVersion"><em>ModelVersion</em></a>) – The version of the model.</p></li>
<li><p><strong>ft_spec</strong> (<em>FinetuneSpec</em>) – The fine-tuning specification for the model.
Generally not used.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelBackend">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelBackend</span></span><a class="headerlink" href="#realhf.ModelBackend" title="Link to this definition">¶</a></dt>
<dd><p>A backend that wraps <a class="reference internal" href="#realhf.Model" title="realhf.Model"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code></a> to provide additional
functionalities such as pipelined model function calls and ZeRO
optimization.</p>
<p>Current backend implementations include inference, DeepSpeed, and Megatron.
The inference backend provides only inference and generation APIs,
while the DeepSpeed and Megatron backends also support training.</p>
<p>The backend offers two main functionalities:</p>
<ol class="arabic simple">
<li><p>Pipelined generation, inference, and training, implemented in ReaL.</p></li>
<li><p>ZeRO optimization, implemented in DeepSpeed and Megatron.</p></li>
</ol>
<p>After initialization, the <code class="docutils literal notranslate"><span class="pre">module</span></code> attribute in <a class="reference internal" href="#realhf.Model" title="realhf.Model"><code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code></a>
will have the same signature as <a class="reference internal" href="#realhf.PipelinableEngine" title="realhf.PipelinableEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelinableEngine</span></code></a>.
See <code class="docutils literal notranslate"><span class="pre">realhf/impl/model/backend</span></code> for concrete implementations.</p>
<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelBackend.destroy">
<span class="sig-name descname"><span class="pre">destroy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelBackend.destroy" title="Link to this definition">¶</a></dt>
<dd><p>Destroy the backend and release GPU memory.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelBackend.initialize">
<span class="sig-name descname"><span class="pre">initialize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">FinetuneSpec</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></span><a class="headerlink" href="#realhf.ModelBackend.initialize" title="Link to this definition">¶</a></dt>
<dd><p>Initialize the model with the backend to support pipelining and
distributed optimization.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.PipelinableEngine">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">PipelinableEngine</span></span><a class="headerlink" href="#realhf.PipelinableEngine" title="Link to this definition">¶</a></dt>
<dd><p>Defines the signature for modules after backend initialization.</p>
<p>Modules with this signature will be passed to <a class="reference internal" href="#realhf.ModelInterface" title="realhf.ModelInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelInterface</span></code></a>
for model function call execution.</p>
<p>See <a class="reference external" href="https://github.com/openpsi-project/ReaLHF/tree/main/realhf/impl/model/backend/inference.py">inference.py</a>,
<a class="reference external" href="https://github.com/openpsi-project/ReaLHF/tree/main/realhf/impl/model/backend/deepspeed.py">deepspeed.py</a>,
and <a class="reference external" href="https://github.com/openpsi-project/ReaLHF/tree/main/realhf/impl/model/backend/megatron.py">megatron.py</a>
for concrete implementations.</p>
<dl class="py method">
<dt class="sig sig-object py" id="realhf.PipelinableEngine.eval_batch">
<span class="sig-name descname"><span class="pre">eval_batch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">loss_fn</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Dict</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_micro_batches</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Dict</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#realhf.PipelinableEngine.eval_batch" title="Link to this definition">¶</a></dt>
<dd><p>Evaluate the model using the forward pass and loss function.</p>
<p>This method wraps <a class="reference internal" href="#realhf.PipelinableEngine.forward" title="realhf.PipelinableEngine.forward"><code class="xref py py-meth docutils literal notranslate"><span class="pre">forward()</span></code></a> with a customized <code class="docutils literal notranslate"><span class="pre">post_hook</span></code> and <code class="docutils literal notranslate"><span class="pre">aggregate_fn</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input</strong> (<a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a>) – The input data. It should contain at least the key <code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code>,
which includes the concatenated token sequences. It should also include any other
entries required to compute the loss.</p></li>
<li><p><strong>loss_fn</strong> (<em>Callable</em><em>[</em><em>[</em><em>torch.Tensor</em><em>, </em><a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a><em>]</em><em>, </em><em>Tuple</em><em>[</em><em>torch.Tensor</em><em>, </em><em>Dict</em><em>]</em><em>]</em>) – The loss function. It takes the output of the forward pass and the
input data, returning the loss and a dictionary of statistics.</p></li>
<li><p><strong>num_micro_batches</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The number of micro-batches to split the batch into.
<strong>This argument is retained for compatibility, although it should not be used</strong>,
since different batch sizes can be directly set in the dataloader, and batch size
during evaluation does not impact algorithmic performance like it does during training.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The aggregated scalar loss and a dictionary of statistics from the last pipeline
stage. Returns None otherwise.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[torch.Tensor, Dict]</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.PipelinableEngine.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">input_:</span> <span class="pre">~realhf.api.core.data_api.SequenceSample,</span> <span class="pre">num_micro_batches:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None,</span> <span class="pre">post_hook:</span> <span class="pre">~typing.Callable[[~torch.Tensor,</span> <span class="pre">~realhf.api.core.data_api.SequenceSample],</span> <span class="pre">~typing.Any]</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None,</span> <span class="pre">aggregate_fn:</span> <span class="pre">~typing.Callable[[~typing.List[~typing.Any]],</span> <span class="pre">~typing.Any]</span> <span class="pre">=</span> <span class="pre">&lt;built-in</span> <span class="pre">method</span> <span class="pre">cat</span> <span class="pre">of</span> <span class="pre">type</span> <span class="pre">object&gt;</span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#realhf.PipelinableEngine.forward" title="Link to this definition">¶</a></dt>
<dd><p>Run the forward pass or inference on the model. Note that it is
gradient-free.</p>
<p>To train the model, use <a class="reference internal" href="#realhf.PipelinableEngine.train_batch" title="realhf.PipelinableEngine.train_batch"><code class="xref py py-meth docutils literal notranslate"><span class="pre">train_batch()</span></code></a> instead.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input</strong> (<a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a>) – The input data. It should contain at least the key <code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code>,
which includes the concatenated token sequences.</p></li>
<li><p><strong>num_micro_batches</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The number of micro-batches to split the batch into.
Regardless of pipelining, mini-batches will be fed into the module one-by-one.
This approach helps reduce GPU memory usage of hidden states. If None, the batch
will not be split.</p></li>
<li><p><strong>post_hook</strong> (<em>Callable</em><em>[</em><em>[</em><em>torch.Tensor</em><em>, </em><a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a><em>]</em><em>, </em><em>Any</em><em>] </em><em>| </em><em>None</em>) – A function to apply to the output after the forward pass.
It takes the output tensor and the input data, returning an arbitrary result.
With a post_hook, we can process the output in mini-batches,
reducing memory usage for operations such as gathering log-probabilities.
If None, this function just returns the output tensor.</p></li>
<li><p><strong>aggregate_fn</strong> (<em>Callable</em><em>[</em><em>[</em><em>List</em><em>[</em><em>Any</em><em>]</em><em>]</em><em>, </em><em>Any</em><em>]</em>) – A function to aggregate the results of the post_hook.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The aggregated result of the post_hook from the last pipeline stage. Returns None otherwise.
The output before post_hook is a concatenated tensor along the batch-sequence dimension, similar to
<code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code>. For example, if we have 3 sequences with lengths [2, 3, 4],
and the vocabulary size is 1000, <code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code> should have shape [9],
and the logits should have shape [9, 1000].</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Any | None</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.PipelinableEngine.generate">
<span class="sig-name descname"><span class="pre">generate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_:</span> <span class="pre">~realhf.api.core.data_api.SequenceSample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tokenizer:</span> <span class="pre">~transformers.tokenization_utils_fast.PreTrainedTokenizerFast</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gconfig:</span> <span class="pre">~realhf.api.core.model_api.GenerationHyperparameters</span> <span class="pre">=</span> <span class="pre">Field(name=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">type=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default=&lt;dataclasses._MISSING_TYPE</span> <span class="pre">object&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default_factory=&lt;class</span> <span class="pre">'realhf.api.core.model_api.GenerationHyperparameters'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">init=True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">repr=True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hash=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compare=True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata=mappingproxy({})</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kw_only=&lt;dataclasses._MISSING_TYPE</span> <span class="pre">object&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_field_type=None)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_micro_batches:</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">None</span> <span class="pre">=</span> <span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Tensor</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#realhf.PipelinableEngine.generate" title="Link to this definition">¶</a></dt>
<dd><p>Generate outputs from the model.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input</strong> (<a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a>) – The input data. It should contain at least the key <code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code>,
which includes the concatenated prompts.</p></li>
<li><p><strong>tokenizer</strong> (<em>transformers.PreTrainedTokenizerFast</em>) – The tokenizer for the model.</p></li>
<li><p><strong>gconfig</strong> (<a class="reference internal" href="#realhf.GenerationHyperparameters" title="realhf.GenerationHyperparameters"><em>GenerationHyperparameters</em></a>) – The generation hyperparameters.</p></li>
<li><p><strong>num_micro_batches</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The number of micro-batches to split the batch into.
Regardless of pipelining, mini-batches will be processed one-by-one by the module.
This approach helps reduce GPU memory usage for hidden states and KV-caches.
If None, the batch will not be split.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>For the last pipeline stage, returns the generated tokens, log probabilities, and optionally the logits mask.
See <a class="reference internal" href="#realhf.GenerationHyperparameters" title="realhf.GenerationHyperparameters"><code class="xref py py-class docutils literal notranslate"><span class="pre">GenerationHyperparameters</span></code></a> for more details about the logits mask.
Returns None for other stages.
The outputs are stacked tensors along the batch dimension. For example,
if we have 3 prompts with lengths [2, 3, 4], a maximum generated length of 5,
and a vocabulary size of 1000, <code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code> should have shape [9],
generated tokens and log probabilities should have shape [3, 5],
and the logits should have shape [3, 5, 1000].</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[torch.Tensor, torch.Tensor, torch.Tensor | None] | None</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.PipelinableEngine.train_batch">
<span class="sig-name descname"><span class="pre">train_batch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">loss_fn</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Dict</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version_steps</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_micro_batches</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">Tensor</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Dict</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#realhf.PipelinableEngine.train_batch" title="Link to this definition">¶</a></dt>
<dd><p>Update the model with a batch of data and a loss function.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input</strong> (<a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a>) – The input data. It should contain at least the key <code class="docutils literal notranslate"><span class="pre">packed_input_ids</span></code>,
which includes the concatenated token sequences. It should also include any other
entries required to compute the loss.</p></li>
<li><p><strong>loss_fn</strong> (<em>Callable</em><em>[</em><em>[</em><em>torch.Tensor</em><em>, </em><a class="reference internal" href="#realhf.SequenceSample" title="realhf.SequenceSample"><em>SequenceSample</em></a><em>]</em><em>, </em><em>Tuple</em><em>[</em><em>torch.Tensor</em><em>, </em><em>Dict</em><em>]</em><em>]</em>) – The loss function. It takes the output of the forward pass and the
input data, returning the loss and a dictionary of statistics.</p></li>
<li><p><strong>version_steps</strong> (<em>int</em>) – The global step counter for this experiment,
used by the backend to determine the learning rate schedule.</p></li>
<li><p><strong>num_micro_batches</strong> (<em>Optional</em><em>[</em><em>int</em><em>]</em>) – The number of micro-batches to split the batch into.
Gradients will be accumulated across micro-batches, and only one update will
occur. For pipelined training, micro-batches are processed together by the engine,
which automatically schedules the forward and backward passes. For non-pipelined
training, forward and backward passes are executed iteratively over mini-batches
to accumulate gradients. If None, the batch will not be split.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The aggregated scalar loss and a dictionary of statistics from the last pipeline
stage. Returns None otherwise.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[torch.Tensor, Dict]</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelInterface">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelInterface</span></span><a class="headerlink" href="#realhf.ModelInterface" title="Link to this definition">¶</a></dt>
<dd><p>An interface for model training, evaluation, inference, and generation.</p>
<p>This interface is designed to follow the dependency injection pattern.
We pass the model to the interface and call its methods, ensuring that model APIs
and algorithms are fully decoupled. For example, REINFORCE and PPO can exhibit
different behaviors during training. Separate interfaces can be written for these
algorithms while using the same model that provides basic forward-backward-update
functionality (i.e., <a class="reference internal" href="#realhf.PipelinableEngine" title="realhf.PipelinableEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelinableEngine</span></code></a>).</p>
<p>During runtime, the master worker requests model workers to execute a specific
interface type (e.g., generate) on a specific model. The model worker locates
the corresponding model, passes it into the requested interface, performs the
computation, and returns the result.</p>
<p>Users can easily create new interfaces to support customized usage.
See <a class="reference internal" href="customization.html"><span class="doc">Customization</span></a> for more details.</p>
<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.evaluate">
<span class="sig-name descname"><span class="pre">evaluate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">eval_dataloader</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">DataLoader</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Dict</span></span></span><a class="headerlink" href="#realhf.ModelInterface.evaluate" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.generate">
<span class="sig-name descname"><span class="pre">generate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_mbs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></span><a class="headerlink" href="#realhf.ModelInterface.generate" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.inference">
<span class="sig-name descname"><span class="pre">inference</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_mbs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></span><a class="headerlink" href="#realhf.ModelInterface.inference" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.mock">
<span class="sig-name descname"><span class="pre">mock</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type_</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></span><a class="headerlink" href="#realhf.ModelInterface.mock" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.save">
<span class="sig-name descname"><span class="pre">save</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelInterface.save" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.train_step">
<span class="sig-name descname"><span class="pre">train_step</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.Model" title="realhf.api.core.model_api.Model"><span class="pre">Model</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#realhf.SequenceSample" title="realhf.api.core.data_api.SequenceSample"><span class="pre">SequenceSample</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_mbs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Dict</span></span></span><a class="headerlink" href="#realhf.ModelInterface.train_step" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

</section>
</section>

</article>
        <aside class="nftt-toc my-3">
          
          <div class="my-sm-1 my-lg-0 ps-xl-3 text-muted">
            <button class="btn btn-link link-dark p-lg-0 mb-2 mb-lg-0 text-decoration-none nftt-toc-toggle d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#tocContents" aria-expanded="false" aria-controls="tocContents"
            >On this page <i class="ms-2 bi bi-chevron-expand"></i></button>
            <div class="title d-none d-lg-block">
              <i class="bi bi-file-earmark-text"></i>&nbsp;&nbsp;<span class="small">On this page</span>
            </div>
            <div class="collapse nftt-toc-collapse" id="tocContents">
              <nav id="TableOfContents">
                <ul>
<li><a class="reference internal" href="#">Configurations</a><ul>
<li><a class="reference internal" href="#experiment-configurations">Experiment Configurations</a><ul>
<li><a class="reference internal" href="#realhf.ExperimentSaveEvalControl"><code class="docutils literal notranslate"><span class="pre">ExperimentSaveEvalControl</span></code></a></li>
<li><a class="reference internal" href="#realhf.CommonExperimentConfig"><code class="docutils literal notranslate"><span class="pre">CommonExperimentConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.SFTConfig"><code class="docutils literal notranslate"><span class="pre">SFTConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.RWConfig"><code class="docutils literal notranslate"><span class="pre">RWConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.DPOConfig"><code class="docutils literal notranslate"><span class="pre">DPOConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.GenerationHyperparameters"><code class="docutils literal notranslate"><span class="pre">GenerationHyperparameters</span></code></a></li>
<li><a class="reference internal" href="#realhf.PPOHyperparameters"><code class="docutils literal notranslate"><span class="pre">PPOHyperparameters</span></code></a></li>
<li><a class="reference internal" href="#realhf.PPOConfig"><code class="docutils literal notranslate"><span class="pre">PPOConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.GenerationConfig"><code class="docutils literal notranslate"><span class="pre">GenerationConfig</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#model-configurations">Model Configurations</a><ul>
<li><a class="reference internal" href="#realhf.ModelFamily"><code class="docutils literal notranslate"><span class="pre">ModelFamily</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelTrainEvalConfig"><code class="docutils literal notranslate"><span class="pre">ModelTrainEvalConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.OptimizerConfig"><code class="docutils literal notranslate"><span class="pre">OptimizerConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.ParallelismConfig"><code class="docutils literal notranslate"><span class="pre">ParallelismConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.MFCConfig"><code class="docutils literal notranslate"><span class="pre">MFCConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.ReaLModelConfig"><code class="docutils literal notranslate"><span class="pre">ReaLModelConfig</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataset-configurations">Dataset Configurations</a><ul>
<li><a class="reference internal" href="#realhf.PromptAnswerDatasetConfig"><code class="docutils literal notranslate"><span class="pre">PromptAnswerDatasetConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.PairedComparisonDatasetConfig"><code class="docutils literal notranslate"><span class="pre">PairedComparisonDatasetConfig</span></code></a></li>
<li><a class="reference internal" href="#realhf.PromptOnlyDatasetConfig"><code class="docutils literal notranslate"><span class="pre">PromptOnlyDatasetConfig</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-structure-for-interfaces-and-datasets">Data Structure for Interfaces and Datasets</a><ul>
<li><a class="reference internal" href="#realhf.SequenceSample"><code class="docutils literal notranslate"><span class="pre">SequenceSample</span></code></a><ul>
<li><a class="reference internal" href="#realhf.SequenceSample.bs"><code class="docutils literal notranslate"><span class="pre">SequenceSample.bs</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.cuda"><code class="docutils literal notranslate"><span class="pre">SequenceSample.cuda()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.disable_validation"><code class="docutils literal notranslate"><span class="pre">SequenceSample.disable_validation()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.from_default"><code class="docutils literal notranslate"><span class="pre">SequenceSample.from_default()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.gather"><code class="docutils literal notranslate"><span class="pre">SequenceSample.gather()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.get_split_spec"><code class="docutils literal notranslate"><span class="pre">SequenceSample.get_split_spec()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.meta"><code class="docutils literal notranslate"><span class="pre">SequenceSample.meta()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.remap_keys_"><code class="docutils literal notranslate"><span class="pre">SequenceSample.remap_keys_()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.split"><code class="docutils literal notranslate"><span class="pre">SequenceSample.split()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.split_with_spec"><code class="docutils literal notranslate"><span class="pre">SequenceSample.split_with_spec()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.unpack"><code class="docutils literal notranslate"><span class="pre">SequenceSample.unpack()</span></code></a></li>
<li><a class="reference internal" href="#realhf.SequenceSample.update_"><code class="docutils literal notranslate"><span class="pre">SequenceSample.update_()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dataflow-graph">Dataflow Graph</a><ul>
<li><a class="reference internal" href="#realhf.MFCDef"><code class="docutils literal notranslate"><span class="pre">MFCDef</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#system-level-configurations">System-Level Configurations</a><ul>
<li><a class="reference internal" href="#realhf.ModelShardID"><code class="docutils literal notranslate"><span class="pre">ModelShardID</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelName"><code class="docutils literal notranslate"><span class="pre">ModelName</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelVersion"><code class="docutils literal notranslate"><span class="pre">ModelVersion</span></code></a></li>
<li><a class="reference internal" href="#realhf.Model"><code class="docutils literal notranslate"><span class="pre">Model</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelBackend"><code class="docutils literal notranslate"><span class="pre">ModelBackend</span></code></a><ul>
<li><a class="reference internal" href="#realhf.ModelBackend.destroy"><code class="docutils literal notranslate"><span class="pre">ModelBackend.destroy()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelBackend.initialize"><code class="docutils literal notranslate"><span class="pre">ModelBackend.initialize()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#realhf.PipelinableEngine"><code class="docutils literal notranslate"><span class="pre">PipelinableEngine</span></code></a><ul>
<li><a class="reference internal" href="#realhf.PipelinableEngine.eval_batch"><code class="docutils literal notranslate"><span class="pre">PipelinableEngine.eval_batch()</span></code></a></li>
<li><a class="reference internal" href="#realhf.PipelinableEngine.forward"><code class="docutils literal notranslate"><span class="pre">PipelinableEngine.forward()</span></code></a></li>
<li><a class="reference internal" href="#realhf.PipelinableEngine.generate"><code class="docutils literal notranslate"><span class="pre">PipelinableEngine.generate()</span></code></a></li>
<li><a class="reference internal" href="#realhf.PipelinableEngine.train_batch"><code class="docutils literal notranslate"><span class="pre">PipelinableEngine.train_batch()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#realhf.ModelInterface"><code class="docutils literal notranslate"><span class="pre">ModelInterface</span></code></a><ul>
<li><a class="reference internal" href="#realhf.ModelInterface.evaluate"><code class="docutils literal notranslate"><span class="pre">ModelInterface.evaluate()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.generate"><code class="docutils literal notranslate"><span class="pre">ModelInterface.generate()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.inference"><code class="docutils literal notranslate"><span class="pre">ModelInterface.inference()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.mock"><code class="docutils literal notranslate"><span class="pre">ModelInterface.mock()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.save"><code class="docutils literal notranslate"><span class="pre">ModelInterface.save()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.train_step"><code class="docutils literal notranslate"><span class="pre">ModelInterface.train_step()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

              </nav>
            </div>
          </div>
          
        </aside>
      </div>
    </div>

    <footer class="nftt-footer">
      <nav id="paginator" class="py-4" aria-label="Documentation navigation">
    <div class="container">
      <ul class="pagination justify-content-between mb-0"><li class="d-flex page-item">
            <a href="install.html" class="d-flex px-5 align-items-end" rel="prev" aria-label="Previous page: Installation">
              <span class="prev-page"><i class="bi bi-caret-left"></i></span>
              <div class="d-none d-sm-flex flex-column">
                <span class="text-small text-start text-muted">Previous</span>
                <span class="underline">Installation</span>
              </div>
            </a>
          </li>
        <li class="d-flex page-item ms-auto">
            <a href="quickstart.html" class="d-flex px-5 align-items-end" rel="next" aria-label="Next page: Quickstart">
              <div class="d-flex flex-column">
                <span class="text-small text-end text-start text-muted">Next</span>
                <span class="underline">Quickstart</span>
              </div>
              <span class="next-page"><i class="bi bi-caret-right"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
  </nav>

      <div class="py-5 px-4 px-md-3">
  <div class="container">
    

    <div class="row">
      <div class="col-lg-12 text-center">
        <a class="brand-text d-inline-flex align-items-center mb-2 text-decoration-none" href="/" aria-label="Nefertiti-for-Sphinx">
          <span class="fs-6 fw-bold">ReaL</span>
        </a>
        
          <ul class="list-unstyled small text-muted">
            <li>2024, Wei Fu & Zhiyu Mei</li>
          </ul>
        
        
        <div class="built-with pt-2">
          Built with <a href="http://sphinx-doc.org">Sphinx 7.3.7</a> and <a href="https://github.com/danirus/sphinx-nefertiti">Nefertiti 0.7.4</a>
        </div>
        
      </div>
    </div>
  </div>
</div>
    </footer>
    <script src="_static/documentation_options.js?v=e259d695"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/docs-versions.js?v=08b0cbfb"></script>
    <script src="_static/sphinx-nefertiti.min.js?v=de1d41e1"></script>
    <script src="_static/bootstrap.bundle.min.js?v=ff4e7878"></script>
  </body>
</html>